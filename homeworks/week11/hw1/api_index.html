<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>留言板</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="warning">
    <strong>本網頁只限於練習，所以忽略了資安問題，切勿把真實帳號密碼輸入</strong>
  </header>
  <main class="container">
    <section>
      <h1>留言板</h1>
        <form class="form">
          <textarea class="form_input content" name="content" cols="30" rows="5"></textarea>
          <button class="btn">送出</button>
        </form>
    </section>
    <section>
    </section>
  </main>

  <script>
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
      }

    async function getComments() {
      const data = await fetch('./api_comments.php')
        .then((res) => {
          if (res.ok || res.statusCode === 200) {
            return res.json()
          }
          throw new Error('Response status is not OK')
        })
        .catch((err) => console.log('error occured is getComments: ', err.message))

      return data
    }

    function renderComment(comment) {
      const articleEl = document.createElement('article')
      articleEl.classList.add('comment')
      articleEl.innerHTML = `
        <div class="comment_avatar"></div>
        <div class="comment_body">
          <div class="comment_info">
            <span class="comment_nickname">
              ${comment.nickname}(@${comment.username})
            </span>
            <span class="comment_time">${comment.created_at}</span>
          </div>
          <div class="comment_content">${escapeHtml(comment.content)}</div>
        </div>
      `
      document.querySelector('section:nth-child(2)').appendChild(articleEl)
    }

    async function addComment(content) {
      const url = 'api_add_comment.php'

      const result = await fetch(
        url,
        {
          method: 'POST',
          body: `username=test&content=${encodeURIComponent(content)}`,
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
          }
        }
      ).then((res) => {
          if (res.ok || res.statusCode === 200) {
            return res.json()
          }
          throw new Error('Response status is not OK')
        })
        .catch((err) => console.log('error occured is addComments: ', err.message))

      if (result.ok) {
        location.reload()
      } else {
        console.log(result)
      }
    }

    getComments()
      .then(({ comments }) => comments.forEach((comment) => renderComment(comment)))

    const form = document.querySelector('.form')
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const content = document.querySelector('textarea.content').value
      addComment(content)
    })
  </script>
</body>
</html>